{% extends "base.html" %}

{% block head %}
<title>{{ quiz.name }} - Results</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/quiz.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/quiz-results.css') }}">
{% endblock %}

{% block body %}
<div class="index-main">
    <div class="results-container">
    <!-- Results Header -->
    <div class="results-header">
        <h1>{{ quiz.name }} - Results</h1>
        <div class="score-display">{{ stats.correct_answers }}/{{ stats.total_questions }}</div>
        <div class="score-percentage">{{ "%.1f"|format(stats.accuracy) }}% Accuracy</div>
        <div class="completion-message">
            {% if stats.accuracy >= 90 %}
                üéâ Excellent work!
                <div class="performance-badge badge-excellent">Outstanding Performance</div>
            {% elif stats.accuracy >= 70 %}
                üëè Well done!
                <div class="performance-badge badge-good">Good Job</div>
            {% else %}
                üìö Keep studying!
                <div class="performance-badge badge-needs-improvement">Room for Improvement</div>
            {% endif %}
        </div>
        {% if progress and progress.completed_at %}
            <p>Completed on {{ progress.completed_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
        {% endif %}
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number correct-stat">{{ stats.correct_answers }}</div>
            <div class="stat-label">Correct Answers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number incorrect-stat">{{ stats.incorrect_answers }}</div>
            <div class="stat-label">Incorrect Answers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number accuracy-stat">{{ "%.1f"|format(stats.accuracy) }}%</div>
            <div class="stat-label">Accuracy Rate</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.total_questions }}</div>
            <div class="stat-label">Total Questions</div>
        </div>
    </div>

    <!-- Question by Question Review -->
    {% if detailed_results %}
    <div class="questions-review">
        <h2 class="section-title">üìù Question by Question Review</h2>
        
        {% for item in detailed_results %}
            <div class="question-item {{ 'question-correct' if item.result.is_correct else 'question-incorrect' }}">
                <div class="question-header">
                    <span class="question-number">Question {{ loop.index }}</span>
                    <span class="question-result-icon">
                        {{ '‚úÖ' if item.result.is_correct else '‚ùå' }}
                    </span>
                </div>
                
                <div class="question-text">{{ item.question.question_text }}</div>
                
                <div class="answer-options">
                    {% for option in item.options_data %}
                        {% set is_user_selected = loop.index0 in item.result.selected_answers %}
                        {% set is_correct_answer = loop.index0 in item.question.correct_answers %}
                        
                        <div class="answer-option 
                            {% if is_correct_answer %}correct-answer{% endif %}
                            {% if is_user_selected and not is_correct_answer %}your-wrong-answer{% endif %}">
                            
                            {% if is_user_selected %}
                                <strong>Your Answer:</strong> {{ option.text if option.text is defined else option }}
                                {{ '‚úÖ' if is_correct_answer else '‚ùå' }}
                            {% elif is_correct_answer %}
                                <strong>Correct Answer:</strong> {{ option.text if option.text is defined else option }} ‚úÖ
                            {% else %}
                                {{ option.text if option.text is defined else option }}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                {% if item.question.explanation and item.question.explanation.strip() %}
                <button class="explanation-toggle" onclick="toggleExplanation({{ loop.index }})">
                    <span>üí° Show Explanation</span>
                    <span class="toggle-icon">‚ñº</span>
                </button>
                <div class="explanation-section" id="explanation-{{ loop.index }}">
                    <h4>üí° Explanation</h4>
                    <p class="explanation-text">{{ item.question.explanation }}</p>
                </div>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{{ url_for('quiz.quiz_detail', quiz_id=quiz.id) }}" class="btn btn-primary">
            üìä View Quiz Details
        </a>
        <form action="{{ url_for('quiz.start_quiz', quiz_id=quiz.id) }}" method="post" class="inline-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <button type="submit" class="btn btn-success">üîÑ Retake Quiz</button>
        </form>
        <a href="{{ url_for('quiz.my_quizzes') }}" class="btn btn-secondary">
            üìö My Quiz History
        </a>
        <a href="{{ url_for('quiz.index') }}" class="btn btn-secondary">
            üè† Back to Home
        </a>
    </div>
    </div>
</div>

<script>
function toggleExplanation(questionIndex) {
    const explanationSection = document.getElementById(`explanation-${questionIndex}`);
    const button = event.target.closest('.explanation-toggle');
    const buttonText = button.querySelector('span:first-child');
    const icon = button.querySelector('.toggle-icon');
    
    if (explanationSection.style.display === 'none' || explanationSection.style.display === '') {
        explanationSection.style.display = 'block';
        buttonText.textContent = 'üí° Hide Explanation';
        button.classList.add('active');
    } else {
        explanationSection.style.display = 'none';
        buttonText.textContent = 'üí° Show Explanation';
        button.classList.remove('active');
    }
}
</script>
{% endblock %}