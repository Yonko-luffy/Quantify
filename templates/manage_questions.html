{% extends "base.html" %}

{% block title %}Manage Questions - Quantify{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/manage-questions.css') }}">
{% endblock %}

{% block body %}
<div class="index-main">
    <div class="manage-questions-container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 style="color: white; font-weight: 600;">üìã Manage Questions</h1>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 1rem;">Create, edit, and organize your quiz questions</p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <a href="{{ url_for('admin.create_question') }}" class="admin-btn">
                    ‚ûï Add New Question
                </a>
                <a href="{{ url_for('admin.admin_panel') }}" class="back-btn">
                    ‚Üê Back to Admin Panel
                </a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="admin-card alert-{{ 'danger' if category == 'error' else 'success' }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Filters Section -->
        <div class="admin-card">
            <h2 style="color: var(--accent); margin-bottom: 1.5rem;">üîç Filter Questions</h2>
            <form method="GET" action="{{ url_for('admin.manage_questions') }}">
                <div class="form-row">
                    <div>
                        <select name="category_id" class="form-input">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" 
                                        {% if selected_category == category.id %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <input type="text" name="search" class="form-input" 
                               placeholder="Search questions..." value="{{ search_term or '' }}">
                    </div>
                    <div>
                        <button type="submit" class="admin-btn">üîç Search</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Questions List -->
        <div class="admin-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="color: var(--accent); margin: 0;">üìù Questions
                    {% if selected_category %}
                        - {{ categories|selectattr('id', 'equalto', selected_category)|first|attr('name') }}
                    {% endif %}
                    ({{ questions|length }} total)
                </h2>
            </div>

            {% if questions %}
                {% for question in questions %}
                    <div class="question-item" data-question-id="{{ question.id }}">
                        <div class="question-header">
                            <div class="question-content">
                                <div class="question-title" onclick="toggleEdit('title-{{ question.id }}')">
                                    {{ question.question_text }}
                                </div>
                                <div class="question-meta">
                                    <span class="badge-custom badge-category">{{ question.category.name }}</span>
                                    <span class="badge-custom badge-options">{{ question.options|length }} options</span>
                                    <span class="badge-custom badge-correct">{{ question.correct_answers|length }} correct</span>
                                </div>
                            </div>
                            <div class="question-actions">
                                <button type="button" class="action-btn btn-view" onclick="toggleOptions('{{ question.id }}')">
                                    üëÅÔ∏è View
                                </button>
                                <a href="{{ url_for('admin.edit_question', question_id=question.id) }}" 
                                   class="action-btn btn-edit">
                                    ‚úèÔ∏è Edit
                                </a>
                                <button type="button" class="action-btn btn-edit" onclick="enableInlineEdit('{{ question.id }}')">
                                    üìù Quick Edit
                                </button>
                                <form method="POST" action="{{ url_for('admin.delete_question', question_id=question.id) }}" 
                                      style="display: inline;" onsubmit="return confirmDelete()">
                                    <button type="submit" class="action-btn btn-delete">üóëÔ∏è Delete</button>
                                </form>
                            </div>
                        </div>

                        <div class="question-options" id="options-{{ question.id }}">
                            <h4 style="color: var(--accent); margin-bottom: 1rem;">Options:</h4>
                            {% for option in question.options %}
                                {% set option_text = option.text if option is mapping else option %}
                                <div class="option-item {% if loop.index0 in question.correct_answers %}correct{% endif %}">
                                    <span class="option-letter">{{ 'ABCDEFGHIJ'[loop.index0] }}</span>
                                    <span class="option-text" data-option-index="{{ loop.index0 }}">
                                        {{ option_text }}
                                    </span>
                                    {% if loop.index0 in question.correct_answers %}
                                        <span class="correct-indicator">‚úì</span>
                                    {% endif %}
                                </div>
                            {% endfor %}

                            {% if question.explanation %}
                                <div class="question-explanation" data-explanation="{{ question.id }}">
                                    <strong>Explanation:</strong> {{ question.explanation }}
                                </div>
                            {% endif %}

                            <div class="edit-controls" id="edit-controls-{{ question.id }}">
                                <button type="button" class="action-btn btn-save" onclick="saveInlineEdit('{{ question.id }}')">
                                    üíæ Save Changes
                                </button>
                                <button type="button" class="action-btn btn-cancel" onclick="cancelInlineEdit('{{ question.id }}')">
                                    ‚ùå Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">‚ùì</div>
                    <h3>No Questions Found</h3>
                    <p>{% if search_term or selected_category %}Try adjusting your filters or{% endif %} start by creating your first question.</p>
                    <a href="{{ url_for('admin.create_question') }}" class="admin-btn">
                        ‚ûï Create First Question
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Toggle options visibility
function toggleOptions(questionId) {
    const options = document.getElementById('options-' + questionId);
    const button = event.target;
    
    if (options.classList.contains('show')) {
        options.classList.remove('show');
        button.textContent = 'üëÅÔ∏è View';
    } else {
        options.classList.add('show');
        button.textContent = 'üëÅÔ∏è Hide';
    }
}

// Enable inline editing
function enableInlineEdit(questionId) {
    const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
    const title = questionItem.querySelector('.question-title');
    const options = questionItem.querySelectorAll('.option-text');
    const explanation = questionItem.querySelector('.question-explanation');
    const editControls = document.getElementById('edit-controls-' + questionId);
    const optionsContainer = document.getElementById('options-' + questionId);
    
    // Show options if hidden
    if (!optionsContainer.classList.contains('show')) {
        optionsContainer.classList.add('show');
    }
    
    // Make title editable
    title.contentEditable = true;
    title.focus();
    
    // Make options editable
    options.forEach(option => {
        option.contentEditable = true;
    });
    
    // Make explanation editable
    if (explanation) {
        explanation.contentEditable = true;
    }
    
    // Show save/cancel controls
    editControls.classList.add('show');
    
    // Store original values for cancel functionality
    title.dataset.original = title.textContent;
    options.forEach(option => {
        option.dataset.original = option.textContent.trim();
    });
    if (explanation) {
        explanation.dataset.original = explanation.textContent;
    }
}

// Save inline edits
function saveInlineEdit(questionId) {
    const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
    const title = questionItem.querySelector('.question-title');
    const options = questionItem.querySelectorAll('.option-text');
    const explanation = questionItem.querySelector('.question-explanation');
    
    // Collect data
    const data = {
        question_text: title.textContent.trim(),
        options: [],
        explanation: explanation ? explanation.textContent.replace('Explanation: ', '').trim() : null
    };
    
    options.forEach(option => {
        data.options.push(option.textContent.trim());
    });
    
    // Send AJAX request
    fetch(`/admin/questions/${questionId}/quick-edit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Disable editing
            cancelInlineEdit(questionId);
            
            // Show success message
            showMessage('Question updated successfully!', 'success');
        } else {
            showMessage(result.error || 'Failed to update question', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred while updating the question', 'error');
    });
}

// Cancel inline edits
function cancelInlineEdit(questionId) {
    const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
    const title = questionItem.querySelector('.question-title');
    const options = questionItem.querySelectorAll('.option-text');
    const explanation = questionItem.querySelector('.question-explanation');
    const editControls = document.getElementById('edit-controls-' + questionId);
    
    // Restore original values
    title.textContent = title.dataset.original;
    options.forEach(option => {
        option.textContent = option.dataset.original;
    });
    if (explanation && explanation.dataset.original) {
        explanation.textContent = explanation.dataset.original;
    }
    
    // Disable editing
    title.contentEditable = false;
    options.forEach(option => {
        option.contentEditable = false;
    });
    if (explanation) {
        explanation.contentEditable = false;
    }
    
    // Hide controls
    editControls.classList.remove('show');
}

// Confirm delete
function confirmDelete() {
    return confirm('Are you sure you want to delete this question? This action cannot be undone.');
}

// Show message
function showMessage(message, type) {
    const container = document.querySelector('.manage-questions-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `admin-card alert-${type}`;
    messageDiv.textContent = message;
    
    container.insertBefore(messageDiv, container.children[1]);
    
    // Remove after 5 seconds
    setTimeout(() => {
        messageDiv.remove();
    }, 5000);
}
</script>
{% endblock %}
